#!/bin/sh

# Unmount USB drives or Android phones. Replaces the older `dmenuumount`. Fewer
# prompt and also de-decrypts LUKS drives that are unmounted.

set -e

mounteddroids="$(grep simple-mtpfs /etc/mtab | awk '{print "üì±" $2}')"
lsblkoutput="$(lsblk -nrpo "name,type,size,mountpoint")"
mounteddrives="$(echo "$lsblkoutput" | awk '($2=="part"||$2="crypt")&&$4!~/\/boot|\/home$|SWAP/&&length($4)>1{printf "üíæ%s (%s)\n",$4,$3}')"

allunmountable="$(echo "$mounteddroids$mounteddrives" | sed "/^$/d;s/ *$//")"
test -n "$allunmountable"

chosen="$(echo "$allunmountable" | dmenu -i -p "Unmount which drive?")"
chosen="${chosen%% *}"
test -n "$chosen"

sudo -A umount -l "/${chosen#*/}"
notify-send "‚èèÔ∏è Device unmounted." "$chosen has been unmounted."

MOUNT_SCRIPT="${XDG_SCRIPTS_HOME:-$HOME/.local/bin}/fecrypt"
MEDIA_PATH="$HOME/Media"
no_mounts=true
while IFS= read -r dir; do
    if mount | grep -q " on ${dir} type"; then
        no_mounts=false
        break
    fi
done < <(find "$MEDIA_PATH" -mindepth 1 -maxdepth 1 -type d)
if [ "$no_mounts" = true ]; then
    $MOUNT_SCRIPT
fi

# Close the chosen drive if decrypted.
cryptid="$(echo "$lsblkoutput" | grep "/${chosen#*/}$")"
cryptid="${cryptid%% *}"
test -b /dev/mapper/"${cryptid##*/}"
sudo -A cryptsetup close "$cryptid"

notify-send "üîí Device dencryption closed." "Drive is now securely locked again."
